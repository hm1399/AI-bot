# MAX98357A 功放原理图设计教程（嘉立创EDA）

> MAX98357A是一颗I2S输入的D类音频功放芯片，ESP32-S3把数字音频数据发给它，它把数字信号变成大功率的模拟信号驱动扬声器发出声音。
> 简单说：它就是一个"数字嘴巴"，收到数字音频信号后变成声音从喇叭里放出来。

---

## 第一步：认识MAX98357A

### 它是什么？

MAX98357A 是一颗非常小的音频功放芯片（TQFN封装 3mm × 3mm），内部集成了：

- DAC（数模转换器，把数字信号变回模拟信号）
- D类功放（高效率的功率放大器，把小信号放大到能驱动扬声器）
- 数字音频接口（直接接收I2S协议的数字音频）
- 保护电路（过热保护、短路保护、开关机消噗声）

你只需要给它供电、接上I2S信号线、接上扬声器，它就能直接播放声音。不需要任何额外的音频编解码芯片，甚至不需要输出滤波电路（传统D类功放需要）。

### 为什么选MAX98357A而不是其他功放？

| 对比 | MAX98357A（I2S数字输入） | PAM8403等模拟功放 |
|------|------------------------|-------------------|
| 输入信号 | 数字（I2S协议） | 模拟（需要DAC先转换） |
| 需要DAC？ | 不需要，自带 | 需要，ESP32-S3内置DAC精度低 |
| 音质 | 高（103.5dB动态范围） | 受DAC精度限制 |
| 效率 | 92%（D类） | D类也高，但模拟输入环节有损耗 |
| 外围元件 | 极少（只需2个电容） | 需要DAC + 耦合电容 + 输入电阻等 |
| 体积 | 3mm × 3mm | 通常更大 |
| 编程 | 不需要I2C配置，自动识别时钟 | - |

### MAX98357A vs MAX98357B

这两颗芯片几乎一样，唯一区别是数字音频接口格式：

| 型号 | 支持的格式 | 左声道标识 |
|------|-----------|-----------|
| MAX98357**A** | I2S格式 | LRCLK = LOW时是左声道 |
| MAX98357**B** | Left-Justified格式 | LRCLK = HIGH时是左声道 |

ESP32-S3默认输出I2S格式，所以我们选 **MAX98357A**。

---

## 第二步：认识MAX98357A的引脚（TQFN-16封装）

MAX98357A有两种封装：WLP（9球，极小，需要特殊PCB工艺）和TQFN-16（16引脚，3mm×3mm，标准封装）。我们选**TQFN-16**，嘉立创PCB可以正常制作和焊接。

| 引脚号 | 名称 | 功能 | 你需要做什么 |
|--------|------|------|-------------|
| 1 | **DIN** | I2S数据输入（ESP32-S3发来的声音数据） | 接ESP32-S3的IO8 |
| 2 | **GAIN_SLOT** | 增益选择（控制音量大小） | 接GND（选12dB增益） |
| 3 | **GND** | 地 | 接GND |
| 4 | **SD_MODE** | 关机控制 + 声道选择 | 接VBAT（常开，左声道） |
| 5 | N.C. | 不连接 | 不接 |
| 6 | N.C. | 不连接 | 不接 |
| 7 | **VDD** | 电源 | 接VBAT，加10uF+100nF去耦电容 |
| 8 | **VDD** | 电源 | 接VBAT（和Pin 7连在一起） |
| 9 | **OUTP** | 扬声器正极输出 | 接喇叭+ |
| 10 | **OUTN** | 扬声器负极输出 | 接喇叭- |
| 11 | **GND** | 地 | 接GND |
| 12 | N.C. | 不连接 | 不接 |
| 13 | N.C. | 不连接 | 不接 |
| 14 | **LRCLK** | I2S帧同步时钟 | 接ESP32-S3的IO18 |
| 15 | **GND** | 地 | 接GND |
| 16 | **BCLK** | I2S位时钟 | 接ESP32-S3的IO17 |
| EP | **散热焊盘** | 底部散热焊盘 | 接GND（散热用） |

---

## 第三步：你需要准备的元件

| 元件 | 值/型号 | 封装 | 数量 | 用途 |
|------|--------|------|------|------|
| MAX98357A 功放 U3 | MAX98357AETE+T | TQFN-16 (3x3mm) | 1 | I2S数字功放 |
| 去耦电容 C6 | 10uF | 0805 | 1 | VDD电源滤波（低频） |
| 去耦电容 C7 | 100nF | 0603 | 1 | VDD电源滤波（高频） |
| 扬声器接口 J2 | 2P排针/接线端子 | - | 1 | 连接3W 4Ω喇叭 |

只需要一颗芯片 + 两颗电容 + 一个喇叭接口。MAX98357A是"免滤波"设计，不需要传统D类功放的LC输出滤波器，这是它最大的优势之一。

---

## 第四步：在嘉立创EDA中放置元件

### 4.1 放置MAX98357A

1. 点击右侧 **"元件库"**（或快捷键 `Shift+F`）
2. 搜索 `MAX98357A`
3. 选择 **TQFN-16** 封装的版本（不要选WLP封装）
4. 优先选嘉立创自营库（带蓝色"嘉"标志）
5. 点击 **"放置"**，在画布上点一下

> **小提示**：如果搜不到，试试搜 `MAX98357AETE` （完整型号）。TQFN封装的后缀通常是`ETE+T`。WLP封装的后缀是`EWL+T`，不要选那个。

### 4.2 放置10uF电容（C6）

1. 搜索 `10uF`，选择 `0805` 封装
2. 放在MAX98357A旁边（靠近VDD引脚Pin 7/8的位置）

### 4.3 放置100nF电容（C7）

1. 搜索 `100nF`，选择 `0603` 封装
2. 放在C6旁边

### 4.4 放置扬声器接口（J2）

1. 搜索 `2P` 排针或接线端子
2. 选一个2pin的连接器，放在靠近OUTP/OUTN引脚的位置
3. 也可以用焊盘（Pad）代替，直接焊接喇叭线

---

## 第五步：连线

### 连接示意图

```text
                              MAX98357A (U3)
                         ┌───────────────────────┐
                         │                       │
  I2S_SPK_DIN ──────────│ DIN (Pin 1)            │
                         │                       │
               GND ─────│ GAIN_SLOT (Pin 2)      │
                         │                       │
               GND ─────│ GND (Pin 3)            │
                         │                       │
              VBAT ─────│ SD_MODE (Pin 4)         │
                         │                       │
                         │ N.C. (Pin 5)           │
                         │ N.C. (Pin 6)           │
                         │                       │
  VBAT ──┬──────────────│ VDD (Pin 7)            │
         │              │ VDD (Pin 8)            │
       C6(10uF)         │                       │
         │              │ OUTP (Pin 9)  ─────────│──── J2 Pin 1 (喇叭+)
       C7(100nF)        │                       │
         │              │ OUTN (Pin 10) ─────────│──── J2 Pin 2 (喇叭-)
        GND             │                       │
                         │ GND (Pin 11)          │──── GND
                         │ N.C. (Pin 12)         │
                         │ N.C. (Pin 13)         │
  I2S_SPK_LRC ─────────│ LRCLK (Pin 14)        │
                         │                       │
               GND ─────│ GND (Pin 15)           │
                         │                       │
  I2S_SPK_BCLK ────────│ BCLK (Pin 16)         │
                         │                       │
                         │ EP (散热焊盘)          │──── GND
                         └───────────────────────┘
```

### 操作步骤

**1. 连接I2S信号线（用网络标签）**

在MAX98357A的对应引脚上放置网络标签：

| 引脚 | 网络标签 | 说明 |
|------|---------|------|
| DIN (Pin 1) | `I2S_SPK_DIN` | 和ESP32-S3的IO8同名，自动连接 |
| LRCLK (Pin 14) | `I2S_SPK_LRC` | 和ESP32-S3的IO18同名，自动连接 |
| BCLK (Pin 16) | `I2S_SPK_BCLK` | 和ESP32-S3的IO17同名，自动连接 |

> 这些标签名必须和你在ESP32-S3模组上放的标签**完全一致**（包括大小写），否则EDA不认为它们是连在一起的。

**2. 连接GAIN_SLOT引脚（音量增益选择）**

用导线把 GAIN_SLOT (Pin 2) 连到 GND 符号。

**3. 连接SD_MODE引脚（开关+声道选择）**

用导线把 SD_MODE (Pin 4) 连到 `VBAT` 电源符号（或放一个 `VBAT` 网络标签）。

**4. 连接电源**

- VDD (Pin 7, Pin 8) 都连到 `VBAT` 电源符号
- 所有GND引脚 (Pin 3, 11, 15) 连到 `GND` 符号
- EP（散热焊盘）也连到 `GND`

**5. 放置去耦电容C6和C7**

- C6 (10uF) 一端连到 VDD 的线上，另一端连到 GND
- C7 (100nF) 一端连到 VDD 的线上，另一端连到 GND
- **两个电容都尽量靠近Pin 7/8放置**

**6. 连接扬声器接口J2**

- J2 Pin 1 连到 OUTP (Pin 9)
- J2 Pin 2 连到 OUTN (Pin 10)

> **注意**：扬声器是"桥接"输出（BTL），两根线（OUTP和OUTN）都是功放输出，**扬声器的任何一端都不能接地**。这和普通耳机不一样——耳机有一端接地，但BTL功放的两端都在输出信号（只是相位相反），这样可以获得更大的输出功率。

---

## 第六步：每个连接的详细解释

### DIN（数据输入）— 为什么这样接？

DIN是功放接收音频数据的线。ESP32-S3通过I2S协议把音频数据（比如语音合成的结果）以数字形式发出来，DIN接收这些数据。

MAX98357A接收到数据后，内部的DAC把数字信号转成模拟信号，再通过D类功放放大，驱动扬声器。

这根线直接连接就行，不需要任何电阻或电容。

### BCLK（位时钟）和 LRCLK（帧时钟）— 为什么需要两个时钟？

和INMP441麦克风一样，I2S协议需要两个时钟信号：

- **BCLK**（Bit Clock）：每一位数据对应一个BCLK脉冲。ESP32-S3发出数据时，BCLK告诉功放"现在来了新的一位数据"
- **LRCLK**（Left/Right Clock）：区分左右声道。LRCLK = LOW时是左声道数据，LRCLK = HIGH时是右声道数据

ESP32-S3是I2S主设备（Master），负责产生BCLK和LRCLK。MAX98357A和INMP441都是从设备（Slave），跟着主设备的节拍工作。

> **和INMP441的区别**：INMP441的时钟线叫SCK/WS，MAX98357A叫BCLK/LRCLK，名字不同但本质一样——都是I2S协议的位时钟和帧时钟。

> **ESP32-S3用不同的I2S端口**：麦克风用I2S端口0（I2S0），功放用I2S端口1（I2S1）。它们的时钟和数据线是独立的，互不干扰。

### GAIN_SLOT（增益选择）— 为什么接GND？

GAIN_SLOT引脚通过检测电平来设置功放的增益（音量放大倍数）：

| GAIN_SLOT接法 | 增益 | 音量效果 |
|--------------|------|---------|
| GND通过100K电阻 | 15dB | 最大 |
| 直接接GND | **12dB** | **较大（推荐）** |
| 悬空不接 | 9dB | 中等 |
| 直接接VDD | 6dB | 较小 |
| VDD通过100K电阻 | 3dB | 最小 |

我们选12dB（GAIN_SLOT直接接GND），是一个比较大的增益，适合桌面助手的使用场景——距离不远，但需要听得清楚。

> **如果觉得声音太大怎么办？** 把GAIN_SLOT改接到VDD（6dB）或者悬空（9dB）。也可以在软件里通过调节I2S数据的音量来控制。
>
> **如果想通过软件控制音量怎么办？** 增益是硬件固定的，不能通过I2C或SPI在线调节。但你可以在ESP32-S3的代码里对音频数据做数字音量控制（乘以一个系数），效果一样。
>
> **能不能接到GPIO实现多档增益切换？** 不能直接这样做，因为GAIN_SLOT需要的是特定的模拟电压（比如GND、VDD或通过电阻分压），而不是简单的高低电平。

### SD_MODE（关机/声道选择）— 为什么接VBAT？

SD_MODE是一个多功能引脚，同时控制开关机和声道选择：

| SD_MODE电平 | 状态 |
|------------|------|
| < 0.16V (B0点) | **关机**（电流仅0.6µA） |
| 0.16V ~ 0.77V | 输出左右声道混合（(左+右)/2） |
| 0.77V ~ 1.4V | 输出右声道 |
| > 1.4V (B2点) | **输出左声道** |

我们把SD_MODE直接接到VBAT（3.7~4.2V），远高于1.4V，所以功放一直开着并且输出左声道数据。

为什么选左声道？因为我们只有一个扬声器，ESP32-S3发送I2S数据时通常把音频放在左声道，和INMP441麦克风（左声道录音）保持一致。

> **想省电？可以用GPIO控制开关**：把SD_MODE接到ESP32-S3的一个空闲GPIO上（比如IO5或IO6），不播放时把GPIO拉低让功放关机（仅耗0.6µA），需要播放时再拉高。注意：GPIO输出3.3V需要大于1.4V才能选中左声道，3.3V满足这个要求。
>
> 但要小心：当电池电压很低时（比如3.0V），如果GPIO输出3.3V，会略高于VDD+0.3V的绝对最大值（3.3V）。如果你想用GPIO控制，建议在SD_MODE和GPIO之间串一个2K电阻做限流。
>
> 对于我们的项目，直接接VBAT最简单，功放一直开着。待机时功放消耗约2.4mA（因为没有I2S时钟信号会自动进入待机模式，消耗降到340µA），完全可以接受。

### VDD（电源）— 为什么用VBAT而不是3V3？

MAX98357A的供电范围是2.5V~5.5V。供电电压越高，扬声器能输出的功率就越大：

| 供电电压 | 4Ω喇叭输出功率(10% THD) | 8Ω喇叭输出功率 |
|---------|------------------------|---------------|
| 3.3V | ~0.5W | ~0.3W |
| 3.7V（电池标称） | ~0.93W | ~0.5W |
| 5.0V（USB） | **3.2W** | **1.8W** |

我们用的是3W 4Ω喇叭。如果用3.3V供电，最大只能输出0.5W左右，声音很小。用VBAT（3.7~4.2V）可以输出约1W，声音明显更大。

`VBAT` 这个网络标签现在先放着，等后面画电源管理电路（TP4056+AMS1117）时，会把电池正极连到这个标签上。

> **数据手册推荐的去耦电容**：10µF + 0.1µF（100nF），和应用电路图完全一致。10µF处理低频波动（功放大电流切换时的电压跌落），100nF处理高频噪声。

### OUTP 和 OUTN（扬声器输出）— 为什么不能接地？

MAX98357A使用**BTL（Bridge-Tied Load，桥接负载）**输出方式：

```text
普通单端输出（耳机模式）：         BTL输出（MAX98357A用这个）：

功放 ──── 喇叭+ ──┐               OUTP ──── 喇叭+ ──┐
                   │ 喇叭                              │ 喇叭
GND  ──── 喇叭- ──┘               OUTN ──── 喇叭- ──┘
```

BTL的好处：同样供电电压下，输出功率是单端的**4倍**。因为两端都在输出信号（相位相反），跨在喇叭上的有效电压是单端的2倍，功率 = V²/R，所以功率变4倍。

**重要**：OUTP和OUTN都不能接地！如果把OUTN接地，功放就变成单端输出了，功率大幅下降，而且可能损坏芯片。

### GND（地）和 EP（散热焊盘）

MAX98357A有3个GND引脚（Pin 3, 11, 15）加一个底部散热焊盘（EP），全部接地。

散热焊盘虽然在电气上不是必须接的（数据手册说"EP is not internally connected"），但接到地平面可以帮助芯片散热。D类功放工作时会发热，特别是大音量播放时，良好的散热能防止过热保护触发（过热时芯片会自动关闭输出）。

> **PCB设计提示**：散热焊盘下方需要铺铜并打散热过孔到背面地平面。这个在PCB布局阶段处理，原理图阶段只需要把EP连到GND就行。

---

## 第七步：检查清单

画完后，逐项确认：

- [ ] MAX98357A (TQFN-16封装) 已放置
- [ ] DIN (Pin 1) 标签 `I2S_SPK_DIN` — 和ESP32-S3的IO8同名
- [ ] GAIN_SLOT (Pin 2) 接GND
- [ ] GND (Pin 3) 接GND
- [ ] SD_MODE (Pin 4) 接VBAT
- [ ] Pin 5, 6, 12, 13 不连接（N.C.）
- [ ] VDD (Pin 7, 8) 接VBAT
- [ ] OUTP (Pin 9) 连到J2 Pin1（喇叭+）
- [ ] OUTN (Pin 10) 连到J2 Pin2（喇叭-）
- [ ] GND (Pin 11, 15) 接GND
- [ ] LRCLK (Pin 14) 标签 `I2S_SPK_LRC` — 和ESP32-S3的IO18同名
- [ ] BCLK (Pin 16) 标签 `I2S_SPK_BCLK` — 和ESP32-S3的IO17同名
- [ ] EP（散热焊盘）接GND
- [ ] C6 (10uF) 接在VBAT和GND之间，紧靠Pin 7/8
- [ ] C7 (100nF) 接在VBAT和GND之间，紧靠Pin 7/8
- [ ] J2 扬声器接口已放置，OUTP和OUTN**没有接地**
- [ ] 所有网络标签拼写与ESP32-S3上的完全一致

---

## 第八步：画完后你应该有这些元件

| 类别 | 元件 | 位号 | 值/型号 | 数量 |
|------|------|------|--------|------|
| 核心 | D类功放 | U3 | MAX98357A / TQFN-16 | 1 |
| 电源 | 去耦电容 | C6 | 10uF / 0805 | 1 |
| 电源 | 去耦电容 | C7 | 100nF / 0603 | 1 |
| 输出 | 扬声器接口 | J2 | 2P连接器 | 1 |

**总计：1个功放 + 2个电容 + 1个接口 + 3个网络标签**

---

## 常见问题

**Q: 嘉立创EDA里搜MAX98357A出来好几个，怎么选？**

关键看**封装**：
- `TQFN-16` 或 `QFN-16 3x3mm`：选这个，16个引脚，标准贴片
- `WLP-9`：不选，9个焊球，需要特殊PCB工艺（盲埋孔），成本高

型号后缀参考：
- `MAX98357AETE+T`：TQFN封装，选这个
- `MAX98357AEWL+T`：WLP封装，不选

**Q: 为什么不需要输出滤波器（LC电路）？**

传统D类功放输出的是高频PWM方波（几百kHz的方波），直接接喇叭会产生严重的电磁干扰（EMI），需要LC滤波器把方波变回平滑的音频信号。

MAX98357A内部使用了Maxim专利的"扩频调制"和"边沿速率控制"技术，大幅降低了EMI辐射。数据手册说即使用12英寸（30cm）的喇叭线也能通过EN55022B的EMI标准，不需要外部滤波器。

这意味着：更少的元件 → 更小的PCB面积 → 更低的成本。

**Q: 喇叭线可以多长？**

数据手册测试用的是12英寸（约30cm）喇叭线。我们的桌面助手里喇叭线很短（几厘米），完全没问题。但如果你想把喇叭放得很远（比如1米以外），建议加一个简单的LC输出滤波器减少EMI。

**Q: VBAT这个标签现在只是悬空的，不影响吗？**

不影响。在原理图阶段，`VBAT` 只是一个网络标签名。DRC可能会提示"电源未连接"的警告，这是正常的——等后面画TP4056+AMS1117电源管理电路时，会在电池正极那里也放一个 `VBAT` 标签，EDA就自动把它们连起来了。

**Q: N.C.（不连接）的引脚需要处理吗？**

不需要接任何东西，留空就行。DRC可能会提示"引脚未连接"警告，可以在引脚上放一个"未连接"标记（在嘉立创EDA里搜索"No Connect"或点击"未连接"工具，放在引脚末端）。

**Q: 功放一直开着不费电吗？**

MAX98357A有自动待机功能：当I2S时钟（BCLK）停止时，芯片自动进入待机模式，电流从正常的2.4mA降到340µA。ESP32-S3不播放音频时自然不会发送I2S时钟，所以功放会自动省电。

如果需要更低功耗（0.6µA），可以把SD_MODE拉低让芯片完全关机。这需要用GPIO控制，前面已经介绍了方法。

**Q: 扬声器选什么规格？**

我们的项目用 **3W 4Ω** 喇叭。选购时注意：
- **阻抗（Ω）**：4Ω或8Ω。4Ω在同等电压下功率更大（声音更大），但芯片发热也更多
- **功率（W）**：喇叭额定功率要 ≥ 功放实际输出功率。VBAT=3.7V时约1W，3W的喇叭完全够用
- **尺寸**：根据你的外壳设计选。常见的有20mm、28mm、40mm直径的圆形喇叭

---

## 下一步

MAX98357A功放电路画好后，你已经完成了音频输入（INMP441麦克风）和音频输出（MAX98357A+喇叭）。理论上焊好板子后就可以做"回声测试"——对着麦克风说话，扬声器立刻播放出来。

建议接下来画 **ST7789 显示屏接口电路**（用来显示时间、天气、状态等）。

准备好了就告诉我。
