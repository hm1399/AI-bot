# ESP32-S3 电容触摸交互原理图设计教程（嘉立创EDA）

> ESP32-S3内置14通道电容触摸传感器（Touch1~Touch14，对应GPIO1~GPIO14），可以直接检测PCB铜皮触摸板上的手指触摸，不需要任何外部触摸芯片。
> 简单说：在PCB上画一块铜皮，连根线到ESP32-S3，手指碰一下它就知道了。

---

## 设计变更说明

**原方案：** TTP223触摸芯片 + 2~3个轻触开关
**新方案：** ESP32-S3自带电容触摸传感器 + PCB触摸焊盘

### 为什么要改？

| 对比 | 原方案（TTP223 + 按键） | 新方案（ESP32-S3内置触摸） |
|------|----------------------|------------------------|
| 元件数量 | TTP223×1 + 按键×3 + 电阻电容若干 | 电阻×3（仅ESD保护） |
| 成本 | TTP223约0.5元 + 按键约0.3元×3 | 几乎为零（铜皮免费） |
| PCB面积 | 需要给TTP223和按键留位置 | 只需要铜皮焊盘 |
| 可靠性 | 按键有机械寿命（约10万次） | 无机械磨损，寿命无限 |
| 灵敏度 | TTP223固定灵敏度 | 软件可调，更灵活 |
| 防水性 | 按键不防水 | 触摸板可以覆盖在外壳下方 |

**代价：** 需要在PCB上设计触摸焊盘，走线有一定要求（后面会讲）。

---

## 第一步：理解ESP32-S3电容触摸原理

### 电容触摸是怎么工作的？

```
                    手指（导体）
                      ↓↓↓
    ┌─────────────────────────────────┐
    │         外壳/覆盖层              │  ← 可以隔着薄外壳
    ├─────────────────────────────────┤
    │      ■■■■■■■■■■■■■■■           │  ← PCB上的铜皮触摸板
    │          │                      │
    │          │ 走线                  │
    │          │                      │
    └──────────┼──────────────────────┘
               │
          ESP32-S3 GPIO（Touch引脚）
```

原理很简单：
1. PCB上的铜皮触摸板和地之间形成一个**小电容**（大约几pF到十几pF）
2. ESP32-S3内部电路不断测量这个电容值
3. 手指靠近或触摸时，人体相当于一个大导体，会**增加**触摸板的电容（增加几pF）
4. ESP32-S3检测到电容变化，判定为"被触摸了"

### ESP32-S3触摸传感器的关键参数

| 参数 | 值 |
|------|-----|
| 触摸通道数 | 14个（Touch1~Touch14） |
| 对应引脚 | GPIO1~GPIO14 |
| 检测方式 | 电容变化检测 |
| 支持功能 | 触摸唤醒（Deep Sleep下也能用） |
| 典型灵敏度 | 可检测隔着2~3mm覆盖层的触摸 |
| 采样速率 | 软件可配置 |

### 哪些引脚可以用？

ESP32-S3的Touch1~Touch14对应GPIO1~GPIO14。但我们的项目中，很多引脚已经被占用了：

| 引脚 | 触摸通道 | 当前状态 | 说明 |
|------|---------|---------|------|
| IO1 | Touch1 | **空闲 ✓** | 可用于触摸 |
| IO2 | Touch2 | **空闲 ✓** | 可用于触摸 |
| IO3 | Touch3 | **空闲 ✓** | 可用于触摸 |
| IO4 | Touch4 | 已占用 | MPU6050中断 |
| IO5 | Touch5 | 已占用 | I2C_SDA |
| IO6 | Touch6 | 已占用 | I2C_SCL |
| IO7 | Touch7 | **空闲 ✓** | 可用于触摸 |
| IO8 | Touch8 | 已占用 | MAX98357A DIN |
| IO9 | Touch9 | 已占用 | ST7789 CS |
| IO10 | Touch10 | 已占用 | ST7789 DC |
| IO11 | Touch11 | 已占用 | ST7789 MOSI |
| IO12 | Touch12 | 已占用 | ST7789 SCK |
| IO13 | Touch13 | **空闲 ✓** | 可用于触摸 |
| IO14 | Touch14 | 已占用 | INMP441 SCK |

**可用触摸通道：IO1、IO2、IO3、IO7、IO13，共5个。**

---

## 第二步：触摸板功能分配

我们用1个触摸板替代原来的TTP223：

| 触摸板 | 引脚 | 网络标签 | 功能 | 交互方式 |
|--------|------|---------|------|---------|
| PAD1 | IO7 | `TOUCH_MAIN` | 主触摸（拍一拍） | 单击=唤醒/确认，双击=取消，长按=关机 |

> **为什么1个就够？** 通过软件区分单击、双击、长按，一个触摸板就能实现多种功能。IO1、IO2、IO3、IO13留作备用，后续需要时可以随时扩展。

---

## 第三步：电路设计

### 电路非常简单

每个触摸板只需要一个串联电阻用于ESD保护：

```
                        R_ESD
  ESP32-S3 IOx ───────┤ 4.7K ├─────── 触摸焊盘
  (Touch通道)          └──────┘        (PCB铜皮)
```

就这么简单。没有上拉电阻、没有去耦电容、没有外部芯片。

### 为什么要加串联电阻？

触摸板直接暴露在外面（或者隔着薄外壳），容易受到静电放电（ESD）冲击。4.7KΩ串联电阻的作用：

1. **限制ESD电流** — 静电打到触摸板时，电阻限制流入ESP32-S3的电流
2. **不影响触摸检测** — 电容触摸检测的是电容变化，不是电流大小，4.7K电阻对检测精度几乎没有影响
3. **低通滤波** — 配合触摸板的寄生电容，形成简单的RC低通滤波，抑制高频噪声

> **能不能不加？** 技术上可以不加，触摸功能照样工作。但强烈建议加上——一颗0603电阻成本不到1分钱，却能大大提高抗静电能力。

### 完整原理图

```
                    4.7K
  IO7 (Touch7) ──┤ R ├──── TOUCH_MAIN ──── [触摸焊盘]
```

元件清单：
| 元件 | 型号 | 封装 | 数量 | 作用 |
|------|------|------|------|------|
| R | 4.7KΩ ±5% | 0603 | 1 | ESD保护串联电阻 |

对比原方案需要的元件：
| 原方案元件 | 数量 | 现在还需要？ |
|-----------|------|------------|
| TTP223触摸芯片 | 1 | ❌ 不需要 |
| 轻触开关 | 2~3 | ❌ 不需要 |
| TTP223去耦电容 | 1 | ❌ 不需要 |
| 按键上拉/下拉电阻 | 2~3 | ❌ 不需要 |
| **ESD保护电阻** | **3** | **✓ 新增** |

净减少约5~7个元件。

---

## 第四步：在嘉立创EDA中绘制原理图

### 4.1 新建原理图页

1. 在嘉立创EDA项目中，右键点击左侧文件树 → **新建原理图**
2. 命名为 `触摸交互` 或 `Touch`

### 4.2 放置ESP32-S3的触摸引脚标签

我们不需要再放一个ESP32-S3符号（它已经在最小系统那张图里了）。只需要用**网络标签**把信号连过去。

在ESP32-S3最小系统原理图中，给IO7引脚添加网络标签：
- IO7 → 标签 `TOUCH_MAIN`

### 4.3 放置ESD保护电阻

1. 按 `P` 打开元件库，搜索 `4.7K 0603`
2. 选择一个0603封装的4.7KΩ电阻（如 `0603WAF4701T5E`）
3. 放置1个（编号根据你的项目实际情况调整）

### 4.4 触摸焊盘子板与主板的连接

触摸焊盘做在独立的小PCB子板上，通过**焊接导线**连接到主板。

每个触摸板需要2根线：
- **信号线**：从主板ESD电阻输出端焊线到子板触摸焊盘
- **GND线**：从主板GND焊线到子板GND（触摸焊盘的接地保护环）

在原理图中的表示方法：在ESD电阻的输出端放置网络标签 `TOUCH_PAD1`、`TOUCH_PAD2`、`TOUCH_PAD3`，同时在主板PCB上预留焊线孔（过孔或焊盘），方便焊接导线。

> **导线长度建议：** 尽量控制在 **50mm以内**。导线越长，引入的寄生电容和噪声越大，触摸灵敏度会下降。如果必须超过50mm，可以用屏蔽线（屏蔽层接GND）。

### 4.5 连线

画出如下连接：

```
  TOUCH_UP   ──── R1 (4.7K) ──── TOUCH_PAD1

  TOUCH_DOWN ──── R2 (4.7K) ──── TOUCH_PAD2

  TOUCH_MAIN ──── R3 (4.7K) ──── TOUCH_PAD3
```

（每条线独立连接，不是并联。）
```
  TOUCH_UP   ──── R1 (4.7K) ──── TOUCH_PAD1

  TOUCH_DOWN ──── R2 (4.7K) ──── TOUCH_PAD2

  TOUCH_MAIN ──── R3 (4.7K) ──── TOUCH_PAD3
```

### 4.6 回到ESP32-S3原理图添加标签

在01_ESP32-S3最小系统的原理图中：
1. 找到IO1引脚 → 放置网络标签 `TOUCH_UP`
2. 找到IO2引脚 → 放置网络标签 `TOUCH_DOWN`
3. 找到IO7引脚 → 放置网络标签 `TOUCH_MAIN`

这样两张原理图就通过同名标签自动连接了。

---

## 第五步：PCB触摸焊盘设计要点

这部分在画PCB时才用到，但提前了解很重要，因为触摸焊盘的设计直接影响灵敏度。

### 触摸焊盘尺寸

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 焊盘形状 | 圆形或方形 | 圆形最常见 |
| 焊盘直径 | 8~12mm | 手指接触面积约8~10mm，焊盘不要比手指小太多 |
| 焊盘间距 | ≥ 5mm（边缘到边缘） | 防止相邻触摸板互相干扰 |
| 铜皮层 | 顶层（Top Layer） | 离手指最近的一层 |

### 走线要求

```
  ESP32-S3          走线              触摸焊盘
  ┌──┐         ┌──────────┐        ┌────────┐
  │IO├─── R ───┤ 尽量短细  ├────────┤ 铜皮   │
  └──┘         │ 不要走地线 │        │ 8~12mm │
               │ 旁边      │        └────────┘
               └──────────┘
```

关键规则：
1. **走线尽量短** — 走线越长，寄生电容越大，灵敏度越低。建议 < 50mm
2. **走线不要和地线平行走** — 会增加对地电容，降低灵敏度
3. **触摸焊盘下方不要铺地** — 焊盘正下方的地铜皮会大幅增加寄生电容
4. **可以加接地保护环** — 在触摸焊盘周围画一圈接地铜皮（间距1~2mm），可以减少相邻触摸板的串扰

### 覆盖层（外壳）

触摸板可以隔着外壳工作：
- **无覆盖**：灵敏度最高，但铜皮暴露
- **0.5~1mm塑料**：灵敏度良好，推荐
- **2~3mm塑料**：仍可工作，需要软件调高灵敏度
- **> 5mm**：可能不可靠，不建议

---

## 第六步：软件配置参考

> 这部分在固件开发阶段才需要，这里先简单列出，方便后续参考。

### Arduino框架示例代码

```cpp
// ESP32-S3 触摸引脚定义
#define TOUCH_MAIN_PIN  7   // IO7 - 主触摸（拍一拍）
#define TOUCH_UP_PIN    1   // IO1 - 上/加
#define TOUCH_DOWN_PIN  2   // IO2 - 下/减

// 触摸阈值（需要根据实际PCB调试）
#define TOUCH_THRESHOLD 40000

void setup() {
    Serial.begin(115200);
}

void loop() {
    // 读取触摸值
    uint32_t val1 = touchRead(TOUCH_MAIN_PIN);
    uint32_t val2 = touchRead(TOUCH_UP_PIN);
    uint32_t val3 = touchRead(TOUCH_DOWN_PIN);

    // 判断是否被触摸（ESP32-S3中触摸时值变大）
    if (val1 > TOUCH_THRESHOLD) {
        Serial.println("主触摸板被触摸！");
    }

    delay(50);
}
```

### Deep Sleep触摸唤醒

ESP32-S3支持在Deep Sleep模式下通过触摸唤醒，非常适合低功耗场景：

```cpp
// 设置触摸唤醒
esp_sleep_enable_touchpad_wakeup();
esp_deep_sleep_start();
// 触摸IO1即可唤醒
```

---

## 常见问题

### Q: 触摸灵敏度不够怎么办？

1. 增大触摸焊盘面积（12mm甚至15mm）
2. 减薄覆盖层
3. 软件中降低触摸阈值
4. 检查触摸焊盘下方是否有地铜皮（有的话去掉）

### Q: 触摸误触发怎么办？

1. 软件中提高触摸阈值
2. 加入去抖动逻辑（连续N次检测到才算触摸）
3. 检查电源噪声（加去耦电容）
4. 触摸走线远离高频信号线（I2S时钟等）

### Q: 能不能同时用触摸和GPIO中断？

可以。ESP32-S3的触摸引脚可以配置为触摸中断模式，触摸时触发中断，不需要轮询。这比TTP223的GPIO输出更灵活。

### Q: 需要保留一个物理按键做复位吗？

建议保留。ESP32-S3的EN引脚已经在最小系统中连接了复位按键，这个不受触摸替换的影响。如果需要额外的物理按键（比如强制进入下载模式），可以用IO0上的按键（也已经在最小系统中设计好了）。

---

## 需要更新的文档

将此方案确认后，以下文档需要同步更新：

1. **claude.md** — 元件清单中：
   - 删除 `TTP223` 行
   - 删除 `轻触开关 x2-3` 行
   - 新增 `触摸焊盘 x3 | PCB铜皮 | ESP32-S3 Touch | 电容触摸交互`
   - 引脚分配新增触摸部分

2. **元件资料区/元件.md** — 同步更新元件清单

3. **功能讨论区/task.md** — 更新相关任务描述

---

## 下一步

这是本项目最后一个硬件模块的原理图。画完后，所有模块就齐了：

1. ✅ ESP32-S3最小系统
2. ✅ INMP441麦克风
3. ✅ MAX98357A功放
4. ✅ ST7789显示屏
5. ✅ 电源管理（TP4056 + AMS1117）
6. ✅ MPU6050陀螺仪
7. ✅ 触摸交互（本文档）

接下来就可以进入**PCB布局布线**阶段了。

准备好了就告诉我，我可以帮你在嘉立创EDA中一步步画这个触摸电路的原理图。
