# 电源管理变更：去掉充电LED，改用GPIO检测 + 屏幕显示

> 本文档记录对05_电源管理原理图的修改：删除CHRG/STDBY引脚上的LED指示灯，改为ESP32-S3通过GPIO读取充电状态，屏幕显示充电UI。

---

## 设计变更说明

**原方案：** TP4056的CHRG/STDBY引脚各接一个LED指示灯（红色充电中、绿色充满）

**新方案：** CHRG/STDBY引脚通过上拉电阻接到ESP32-S3的GPIO，软件读取充电状态，屏幕显示充电动画

### 为什么要改？

| 对比 | 原方案（LED指示灯） | 新方案（GPIO + 屏幕UI） |
|------|-------------------|----------------------|
| 元件数量 | 2个LED + 2个1KΩ电阻 | 2个10KΩ电阻 |
| 显示信息 | 只能亮/灭 | 可显示电量百分比、充电动画、预计时间等 |
| 用户体验 | 需要看设备背面找小灯 | 正面屏幕直接显示，更直观 |
| PCB面积 | LED占位置 | 省掉2个LED的面积 |

### 关机充电怎么办？

本项目的拨动开关（SW1 SK12D07VG3）定位为**仓储开关**，平时始终保持ON。日常"关机"使用ESP32-S3的Deep Sleep模式。

- Deep Sleep下，CHRG引脚拉低 → IO38检测到低电平 → 唤醒ESP32-S3 → 屏幕显示充电画面
- 和手机关机充电显示充电动画的逻辑一样
- 只有长期不用时才拨到OFF（此时插USB只充电，无显示，但这种场景极少）

---

## 原理图修改

### 删除的元件（4个）

| 元件 | 参数 | 原来的连接 |
|------|------|-----------|
| LED1 | 红色 0603 | 5VUSB → R2 → LED1 → CHRG(引脚7) |
| LED2 | 绿色 0603 | 5VUSB → R3 → LED2 → STDBY(引脚6) |
| R2 | 1KΩ 0603 | LED1限流电阻 |
| R3 | 1KΩ 0603 | LED2限流电阻 |

### 新增的元件（2个）

| 元件 | 参数 | 封装 | 数量 | 用途 |
|------|------|------|------|------|
| R_CHG | 10KΩ ±5% | 0603 | 1 | CHRG引脚上拉电阻 |
| R_STDBY | 10KΩ ±5% | 0603 | 1 | STDBY引脚上拉电阻 |

### 新增的网络标签（2个）

| 网络标签 | 含义 | 连接到 |
|---------|------|--------|
| `CHG_STATUS` | 充电中状态信号 | TP4056 CHRG(引脚7) ↔ ESP32-S3 IO38 |
| `CHG_DONE` | 充满状态信号 | TP4056 STDBY(引脚6) ↔ ESP32-S3 IO39 |

### 新电路连接

```
         R_CHG (10KΩ)
3V3 ────┤├────┬──── TP4056 CHRG (引脚7)
              │
              └──── CHG_STATUS ──── (同名标签连到ESP32-S3 IO38)

         R_STDBY (10KΩ)
3V3 ────┤├────┬──── TP4056 STDBY (引脚6)
              │
              └──── CHG_DONE ──── (同名标签连到ESP32-S3 IO39)
```

### 信号逻辑

CHRG和STDBY都是TP4056的**开漏输出**，需要外部上拉电阻才能读取：

| IO38 (CHG_STATUS) | IO39 (CHG_DONE) | 含义 |
|-------------------|-----------------|------|
| 低电平 | 高电平 | 正在充电 |
| 高电平 | 低电平 | 已充满 |
| 高电平 | 高电平 | 未充电（没插USB或无电池） |

> **为什么上拉到3V3而不是5VUSB？** ESP32-S3的GPIO耐压是3.3V，上拉到5V会烧引脚。上拉到3V3既安全，又能在设备开机时（3V3有电）正常读取状态。

> **为什么用10KΩ？** 开漏输出只需要很小的电流就能拉低，10KΩ上拉时电流仅0.33mA，功耗极低。用1KΩ也能工作但没必要浪费电流。

---

## 嘉立创EDA操作步骤

### 步骤1：在电源管理原理图中删除旧元件

1. 打开电源管理原理图页面
2. 选中 **LED1**（红色LED）→ 按 `Delete` 删除
3. 选中 **LED2**（绿色LED）→ 按 `Delete` 删除
4. 选中 **R2**（1KΩ，LED1限流电阻）→ 按 `Delete` 删除
5. 选中 **R3**（1KΩ，LED2限流电阻）→ 按 `Delete` 删除
6. 清理残留的悬空导线（选中后按 `Delete`）

### 步骤2：放置新的上拉电阻

1. 按 `P` 打开元件库，搜索 `10K 0603`
2. 选择一个0603封装的10KΩ电阻
3. 放置2个，分别命名为 R_CHG 和 R_STDBY（编号根据项目实际调整）

### 步骤3：连线

**CHRG引脚（充电中检测）：**
1. R_CHG 一端连接到 `3V3` 网络标签
2. R_CHG 另一端连接到 TP4056 的 CHRG（引脚7）
3. 在 R_CHG 与 CHRG 的连接点处，放置网络标签 `CHG_STATUS`

**STDBY引脚（充满检测）：**
1. R_STDBY 一端连接到 `3V3` 网络标签
2. R_STDBY 另一端连接到 TP4056 的 STDBY（引脚6）
3. 在 R_STDBY 与 STDBY 的连接点处，放置网络标签 `CHG_DONE`

### 步骤4：在ESP32-S3最小系统原理图中添加标签

1. 切换到 01_ESP32-S3最小系统 原理图页面
2. 找到 ESP32-S3 的 **IO38** 引脚 → 放置网络标签 `CHG_STATUS`
3. 找到 ESP32-S3 的 **IO39** 引脚 → 放置网络标签 `CHG_DONE`

两张图通过同名标签自动连接。

---

## Deep Sleep触摸唤醒 + 充电唤醒

ESP32-S3支持多种唤醒源同时生效：

```cpp
// 设置触摸唤醒（拍一拍唤醒）
esp_sleep_enable_touchpad_wakeup();

// 设置GPIO唤醒（插USB充电唤醒）
// IO38 = CHG_STATUS，充电时为低电平
esp_sleep_enable_ext0_wakeup(GPIO_NUM_38, 0);  // 0 = 低电平唤醒

// 进入深度睡眠
esp_deep_sleep_start();

// 唤醒后判断唤醒原因
esp_sleep_wakeup_cause_t cause = esp_sleep_get_wakeup_cause();
if (cause == ESP_SLEEP_WAKEUP_EXT0) {
    // 被充电唤醒 → 显示充电画面
    show_charging_screen();
} else if (cause == ESP_SLEEP_WAKEUP_TOUCHPAD) {
    // 被触摸唤醒 → 正常开机
    normal_boot();
}
```

---

## 修改后的电源管理完整连接

```
USB Type-C 5V (5VUSB)
       │
       ├──── TP4056 VCC (引脚4)
       └──── TP4056 CE  (引脚8)

TP4056:
  TEMP  (引脚1) ──── GND
  PROG  (引脚2) ──── R1(1.2KΩ) ──── GND
  GND   (引脚3) ──── GND
  BAT   (引脚5) ──── VBAT ──── 电池正极
  CHRG  (引脚7) ──┬── R_CHG(10KΩ) ──── 3V3
                  └── CHG_STATUS ──── ESP32-S3 IO38
  STDBY (引脚6) ──┬── R_STDBY(10KΩ) ── 3V3
                  └── CHG_DONE ─────── ESP32-S3 IO39

电池(VBAT) → SW1拨动开关 → VBAT_SW → AMS1117 → 3V3
```

---

## 检查清单

### 连线检查
- [ ] 已删除 LED1、LED2、R2、R3 及相关导线
- [ ] R_CHG(10KΩ) 一端接 3V3，另一端接 CHRG(引脚7)
- [ ] R_STDBY(10KΩ) 一端接 3V3，另一端接 STDBY(引脚6)
- [ ] CHRG节点有网络标签 `CHG_STATUS`
- [ ] STDBY节点有网络标签 `CHG_DONE`
- [ ] ESP32-S3的 IO38 有网络标签 `CHG_STATUS`
- [ ] ESP32-S3的 IO39 有网络标签 `CHG_DONE`

### 元件值检查
- [ ] R_CHG = 10KΩ，0603封装
- [ ] R_STDBY = 10KΩ，0603封装
- [ ] R1 = 1.2KΩ 不变（充电电流编程电阻）
